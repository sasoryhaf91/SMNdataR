---
title: "Untitled"
output: pdf_document
date: "2025-02-25"
---

```{python}
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
```

```{r}
list.files("C:/Users/uiemh/Downloads/SMNdataR/data")
```


```{python}
import pandas as pd

path = r"C:/Users/uiemh/Downloads/SMNdataR/data/prec_daily_1961-2023.csv"
df = pd.read_csv(path)
df.head()
```

```{python}
# Obtener la cantidad total de registros
total_registros = len(df)

print(f"Cantidad total de registros en el dataset: {total_registros}")
```


```{python}
# Convertir la fecha a tipo datetime si existe
if 'date' in df.columns:
    df['date'] = pd.to_datetime(df['date'])
    df['year'] = df['date'].dt.year
    df['month'] = df['date'].dt.month
    df['doy'] = df['date'].dt.dayofyear

# Cantidad total de estaciones únicas
total_estaciones = df['station'].nunique()
print(f"Total de estaciones únicas: {total_estaciones}")
```

```{python}
# Cantidad de registros por año
registros_por_año = df.groupby('year').size().reset_index(name='records')
print("\nRegistros por año:")
print(registros_por_año)
```

```{python}
# Cantidad de registros por estación
registros_por_estacion = df.groupby('station').size().reset_index(name='records')
print("\nRegistros por estación:")
print(registros_por_estacion)
```

```{r}
library("reticulate")
# Save the plot as a high-resolution image (optional for publication)
#png("records_trend.png", width = 1800, height = 1200, res = 300)  # 300 dpi for high quality

plot(py$registros_por_año[['year']],py$registros_por_año[['records']], 
     type='b',
     col = 'black', 
     pch = 19,
     xlab = "Year",
     ylab = "# records",
     main = "Anual records evolution")
# Close the device if saving the image
#dev.off()

```

```{r}
# Convert the Python DataFrame to an R object
df_r <- as.data.frame(py$registros_por_año)

# Save the plot as a high-resolution image (optional for publication)
#png("records_trend.png", width = 1800, height = 1200, res = 300)  # 300 dpi for high quality

# Create the improved plot
plot(df_r$year, df_r$records, 
     type = "b",                  # "b" for both points and lines
     pch = 16,                     # Solid points
     col = "blue",                 # Point color
     lty = 1,                      # Solid line type
     lwd = 2,                      # Thicker line width
     xlab = "Year",                # X-axis label
     ylab = "Number of Records",   # Y-axis label
     main = "Annual Record Evolution",  # Title
     cex.lab = 1.5,                # Larger axis labels
     cex.axis = 1.2,               # Larger axis values
     cex.main = 1.8,               # Larger title size
     col.main = "black",           # Title color
     col.lab = "black",            # Label color
     col.axis = "black")           # Axis value color

# Close the device if saving the image
#dev.off()
```

```{r}
# Convert the Python DataFrame to an R object
df_r <- as.data.frame(py$registros_por_año)

# Function to format large numbers with commas
format_large_numbers <- function(x) format(x, big.mark = ",", scientific = FALSE)

# Open a graphical device for high-resolution output
#png("records_trend.png", width = 1800, height = 1200, res = 300)

# Adjust margins to fix label positioning
par(mar = c(5, 6, 4, 2))  # Increase left margin to fit y-axis label properly

# Create the improved plot
plot(df_r$year, df_r$records, 
     type = "l",                  # Use line plot for a smoother look
     col = "blue",                 # Line color
     lty = 1,                      # Solid line type
     lwd = 1.5,                    # Line thickness
     xlab = "Year",                # X-axis label
     ylab = "Number of Records",   # Y-axis label (corrected alignment)
     main = "Annual Record Evolution",  # Title
     cex.lab = 1.5,                # Larger axis labels for clarity
     cex.axis = 1.2,               # Adjusted axis values for readability
     cex.main = 1.8,               # Adjusted title size
     col.main = "black",           # Title color
     col.lab = "black",            # Label color
     col.axis = "black",           # Axis value color
     las = 0,                      # Keep y-axis label horizontal
     xaxt = "n",                   # Remove default x-axis labels for customization
     yaxt = "n")                   # Remove default y-axis labels for customization

# Customize x-axis (years) with **spaced-out labels**
axis(1, at = seq(min(df_r$year), max(df_r$year), by = 5),  # Show every 5 years
     labels = seq(min(df_r$year), max(df_r$year), by = 5),
     cex.axis = 1.2, las = 1)

# Customize y-axis (formatted large numbers) with **spaced-out labels**
axis(2, at = pretty(df_r$records), labels = format_large_numbers(pretty(df_r$records)), 
     cex.axis = 1.2, las = 1)  # Keep numbers horizontal

# Close the graphical device (if saving)
#dev.off()

```

```{python}
# Cantidad de registros por mes
registros_por_mes = df.groupby('month').size().reset_index(name='records')
print("\nRegistros por mes:")
print(registros_por_mes)
```

```{python}
# Cantidad de registros por día del año
registros_por_dia = df.groupby('doy').size().reset_index(name='records')
print("\nRegistros por día del año:")
print(registros_por_dia)
```

```{r}
library("reticulate")
# Save the plot as a high-resolution image (optional for publication)
# Convert the Python DataFrame to an R object
df_r <- as.data.frame(py$registros_por_dia)
#png("records_doy.png", width = 1800, height = 1200, res = 300)  # 300 dpi for high quality

plot(df_r$doy,df_r$records, 
     type='b',
     col = 'black', 
     pch = 19,
     xlab = "Year",
     ylab = "# records",
     main = "Daily records evolution")
# Close the device if saving the image
#dev.off()

```



```{r}
library("reticulate")
# Save the plot as a high-resolution image (optional for publication)
# Convert the Python DataFrame to an R object
df_r <- as.data.frame(py$registros_por_estacion)
#png("records_doy.png", width = 1800, height = 1200, res = 300)  # 300 dpi for high quality

plot(df_r$station,df_r$records, 
     type='o',
     col = 'black', 
     pch = 19,
     xlab = "Station",
     ylab = "# records",
     main = "Station records evolution")
# Close the device if saving the image
#dev.off()
```

```{python}
# Verificar que el dataset tenga las columnas necesarias
if {'latitude', 'longitude', 'station'}.issubset(df.columns):
    # Crear figura
    plt.figure(figsize=(10, 6))
    
    # Graficar todas las estaciones (capa rasterizada para reducir el tamaño del PDF)
    plt.scatter(df['longitude'], df['latitude'], s=10, c='blue', label='training', 
                alpha=0.5, rasterized=True)
    
    # Filtrar y graficar las estaciones de validación (también rasterizadas)
    data_validacion = df[df['station'].isin(est_validacion)]
    plt.scatter(data_validacion['longitude'], data_validacion['latitude'], s=10, c='red', 
                label='validation', alpha=0.5, rasterized=True)
    
    # Configurar etiquetas y título
    plt.xlabel('longitude')
    plt.ylabel('latitude')
    plt.title('Validation Stations')
    plt.legend(title="Type")
    plt.grid(True, linestyle="--", alpha=0.5)
    
    # Guardar el gráfico en PDF con dpi controlado para mantener un tamaño razonable
    plt.savefig("est_val_light.pdf", format="pdf", bbox_inches="tight", dpi=300)
    plt.show()
else:
    print("El dataset no contiene las columnas requeridas: 'latitud', 'longitud' o 'estacion'.")
```


```{python}
# Verificar que el dataset tenga las columnas de latitud y longitud
if {'latitude', 'longitude'}.issubset(df.columns):
    plt.figure(figsize=(10, 6))
    plt.scatter(df['longitude'], df['latitude'], s=10, alpha=0.5, label="Stations", color="blue")
    plt.xlabel("Longitude")
    plt.ylabel("Latitude")
    plt.title("Spatial distribution")
    plt.legend()
    plt.grid(True, linestyle="--", alpha=0.5)
    plt.show()
else:
    print("El dataset no contiene columnas de latitud y longitud.")
```

```{r}
devtools::load_all()
data("estaciones")
```

```{r}
#est_15195 <- smndata_download_stations_annual(15195,"prec",output_format = "all")
#est_3166 <- smndata_download_stations_annual(3166,"prec",output_format = "all")
est_7238 <- smndata_download_stations_monthly(7238,"prec",output_format = "all")
```

```{r}
#plot(est_15195$year,est_15195$prec,type = "b")
#plot(est_3166$year,est_3166$prec,type = "b")
plot(as.Date(est_7238$date),est_7238$prec,type = "b")
```

